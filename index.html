<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>抽獎活動</title>
    <link rel="stylesheet" href="styles.css">
</head>
<style>
    body {
        font-family: Arial, sans-serif;
        background-color: black;
        color: #333;
    }
    
    .container {
        width: 80%;
        margin: 0 auto;
        border:white 5px solid;
        background-color: black;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        color:white;
    }
    h1{
        color: white;
        text-align: center;
    }
    .header, .prize-section, .participants-section, .result-section {
        margin-bottom: 20px;
    }
    
    label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
    }
    
    input[type="text"], textarea {
        width: 100%;
        padding: 10px;
        margin-bottom: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
    }
    
    button {
        padding: 10px 20px;
        border: none;
        background-color: #007bff;
        color: #fff;
        border-radius: 5px;
        cursor: pointer;
    }
    
    button:hover {
        background-color: #0056b3;
    }
    
    .result-section h2 {
        margin-bottom: 10px;
    }
    
    #results {
        color: black;
        background-color: #e9ecef;
        padding: 10px;
        border-radius: 5px;
    }

    textarea{
        width: 98%;
        padding: 10px;
        margin-bottom: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
        font-size: 14px;
    }
    
</style>
<body>
    <h1>JB 抽獎</h1>
    <div class="container">
        <div class="participants-section">
            <label for="participantList">待抽名單：</label>
            <textarea id="participantList" name="participantList" rows="10" placeholder="ID, 月數"></textarea>
        </div>
        <div class="prize-section">
            <label for="prizeDetails">獎項內容：</label>
            <textarea id="prizeDetails" name="prizeDetails" rows="5" placeholder="獎品, 數量"></textarea>
        </div>
        
        <div class="result-section">
            <h2>中獎結果：</h2>
            <p id="results"></p>
        </div>
        <div>
            <button id="start">抽獎</button>
            <button id="reset">重置</button>
        </div>
    </div>
    <script>
        const drawButton = document.getElementById('start');
        const clearButton = document.getElementById('reset');
        const resultDisplay = document.getElementById('results');
        let drawResults = []; // 全局变量用于存储所有抽奖结果
        let currentPrizeIndex = 0; // 当前抽取的奖品索引
        let participantsGlobal = []; // 全局变量用于存储参与者列表

    function drawPrize() {
      let participantsText = document.getElementById('participantList').value.trim();
      let prizesText = document.getElementById('prizeDetails').value.trim();
      
      // 如果参与者列表为空，则初始化
      if (participantsGlobal.length === 0) {
        participantsGlobal = participantsText.split('\n').map(participant => {
          let [name, rate] = participant.split(',').map(item => item.trim());
          return { name, rate: parseFloat(rate) };
        }).filter(participant => participant.name !== '' && !isNaN(participant.rate) && participant.rate > 0);
      }
      
      // 将奖品列表转换为数组，每行作为一个元素
      let prizes = prizesText.split('\n').map(prize => {
        let [name, count] = prize.split(',').map(item => item.trim());
        return { name, count: parseInt(count, 10) };
      }).filter(prize => prize.name !== '' && !isNaN(prize.count) && prize.count > 0);
      
      // 检查输入是否正确
      if (participantsGlobal.length === 0 || prizes.length === 0) {
        resultDisplay.textContent = "请输入参與者和獎品列表。";
        return;
      }
      
      // 如果所有奖品都已经抽完
      if (currentPrizeIndex >= prizes.length) {
        resultDisplay.textContent = "所有獎品都已經抽完。";
        return;
      }
      
      // 抽取当前奖品
      const currentPrize = prizes[currentPrizeIndex];
      const prizeName = currentPrize.name;
      const prizeCount = currentPrize.count;
      
      // 验证参与者数量是否足够
      if (participantsGlobal.length < prizeCount) {
        resultDisplay.textContent = `参與者不足以抽出 ${prizeCount} 个 "${prizeName}"。`;
        return;
      }
      
      // 抽取中奖者，根据中奖倍率设置中奖概率
      let winners = [];
      for (let i = 0; i < prizeCount; i++) {
        // 总倍率
        const totalRate = participantsGlobal.reduce((acc, participant) => acc + participant.rate, 0);
        
        // 随机选择中奖者
        let randomNumber = Math.random() * totalRate;
        let accumulatedRate = 0;
        let selectedParticipant = null;
        
        for (let participant of participantsGlobal) {
          accumulatedRate += participant.rate;
          
          if (randomNumber <= accumulatedRate) {
            selectedParticipant = participant.name;
            break;
          }
        }
        
        // 从参与者中移除中奖者
        participantsGlobal = participantsGlobal.filter(participant => participant.name !== selectedParticipant);
        
        winners.push(selectedParticipant);
      }
      
      // 将中奖结果添加到全局变量中
      drawResults.push({ prize: prizeName, winners });
      
      // 显示当前奖品的中奖者
      resultDisplay.innerHTML = `${prizeName} ： <br>${winners.join('<br>')}`;
      resultDisplay.innerHTML += `<br><br><button id="nextButton">下一個</button>`;
      
      // 监听抽下一个奖品按钮的点击事件
      const nextButton = document.getElementById('nextButton');
      nextButton.addEventListener('click', () => {
        currentPrizeIndex++; // 切换到下一个奖品
        if (currentPrizeIndex < prizes.length) {
          drawPrize(); // 抽取下一个奖品
        } else {
          // 所有奖品抽完，显示所有抽奖结果
          let finalResult = '<strong>所以抽獎結果：</strong><br>';
          drawResults.forEach(result => {
            finalResult += `<p><br>${result.prize} ： <br>${result.winners.join('<br>')}</p>`;
          });
          resultDisplay.innerHTML = finalResult;
        }
      });
    }

    drawButton.addEventListener('click', drawPrize);

    clearButton.addEventListener('click', () => {
      drawResults = [];
      currentPrizeIndex = 0;
      participantsGlobal = [];
      resultDisplay.innerHTML = '';
    });
    </script>
</body>
</html>
